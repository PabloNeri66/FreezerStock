{% extends "base.html" %}

{% block title %}Oslo Gelados - FreezerStock{% endblock title %}

{% block content %}

    <h3>Dashboard</h3>

    {% include "components/_geladinho_metrics.html" %}

    {% include "components/_sales_metrics.html" %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <div class="row mt-4 justify-content-center ">

        <div class="col-md-6 text-center" style="border-right: 1px solid #525252ff;">
            <h5 class="text-center mb-3">
                Valor de Vendas Ãšltimos 7 Dias
            </h5>
            <canvas id="dailySalesChart"></canvas>
        </div>
        <div class="col-md-6 text-center">
            <h5 class="text-center mb-3">
                Quantidade de Vendas DiÃ¡rias
            </h5>
            <canvas id="dailySalesQuantityChart"></canvas>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
            var dailySalesData = JSON.parse('{{ daily_sales_data|safe }}');
            var dailySalesQuantityData = JSON.parse('{{ daily_sales_quantity_data|safe }}');
    
            var ctxDailySales = document.getElementById('dailySalesChart').getContext('2d');
            var dailySalesChart = new Chart(ctxDailySales, {
                type: 'line',
                data: {
                    labels: dailySalesData.dates,
                    datasets: [{
                        label: 'Valor em vendas',
                        data: dailySalesData.values,
                        fill: false,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.5
                    }]
                },
            options: {
                scales: {
                    y: {
                    beginAtZero: true
                    }
                }
                }
            });
    
            var ctxDailySalesQuantity = document.getElementById('dailySalesQuantityChart').getContext('2d');
            var dailySalesQuantityChart = new Chart(ctxDailySalesQuantity, {
                type: 'bar',
                data: {
                    labels: dailySalesQuantityData.dates,
                    datasets: [{
                        label: 'Quantidade de Vendas',
                        data: dailySalesQuantityData.values,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
            },
            options: {
                scales: {
                    y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,     // ðŸ‘ˆ FORÃ‡A O EIXO A USAR INTEIROS
                        precision: 0     // ðŸ‘ˆ EVITA FLOATS
                        }
                    }
                }
                }
            });
        });
        </script>
    </div>

    <div class="container border-top pt-3"></div>

    <div class="row mt-4 justify-content-center">
        <div class="col-md-6 text-center">
            <h5 class="mb-3">
                Geladinho Por Sabor
            </h5>
            <div class="mb-4"></div>
            <div class="embed-responsive embed-responsive-1by1" style="width: 400px; display: inline-block;">
                <canvas id="geladinhoByFlavorChart"></canvas>
            </div>
            <div class="container"></div>

            <script>
            document.addEventListener("DOMContentLoaded", function() {

                // --- dados vindos da view ---
                const geladinhoCountByFlavor = JSON.parse('{{ geladinho_count_by_flavor|safe }}');
                const geladinhoColors = {{ geladinho_colors|safe }};

                // --- filtra sabores com quantidade maior que 0 ---
                const entries = Object.entries(geladinhoCountByFlavor)
                    .filter(([label, value]) => value > 0);

                const flavorLabels = entries.map(([label]) => label);
                const flavorValues = entries.map(([_, value]) => value);
                const flavorBgColors = flavorLabels.map(label => geladinhoColors[label]);

                // --- monta o grÃ¡fico ---
                const ctx = document.getElementById('geladinhoByFlavorChart').getContext('2d');

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: flavorLabels,
                        datasets: [{
                            data: flavorValues,
                            backgroundColor: flavorBgColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: { size: 14 }
                                }
                            }
                        }
                    }
                });

            });
            </script>
            <div class='mb-1'></div>
    </div>


{% endblock content %}